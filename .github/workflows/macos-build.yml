name: Build macOS App with Python Backend

on:
  workflow_dispatch:
  push:
    branches: [Temp]

jobs:
  build-backend:
    name: ðŸ Build Python Backend
    runs-on: macos-13

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ðŸ“¦ Install dependencies
        run: |
          python3 -m pip install --upgrade pip setuptools wheel pyinstaller
          pip install -r videoQueries/requirements.txt

      - name: ðŸ› ï¸ Build macOS app using PyInstaller
        working-directory: videoQueries
        run: |
          pyinstaller main.py --onefile --windowed --distpath ../backend_dist

      - name: ðŸ“¤ Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-app
          path: backend_dist/main

  build-frontend:
    name: ðŸ’» Build Flutter macOS App
    runs-on: macos-13
    needs: build-backend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
        with:
          lfs: true
          fetch-depth: 0

      - name: ðŸ’» Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'
          channel: stable

      - name: ðŸ”§ Enable macOS desktop
        run: flutter config --enable-macos-desktop

      - name: ðŸ“¦ Install dependencies
        run: flutter pub get

      - name: ðŸ—ï¸ Build Flutter macOS app
        run: flutter build macos --release

      - name: ðŸ“¤ Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-app
          path: build/macos/Build/Products/Release/

  create-launcher:
    name: ðŸ“ Create Launcher Script
    runs-on: macos-13
    needs: [build-backend, build-frontend]

    steps:
      - name: ðŸ“¥ Download backend
        uses: actions/download-artifact@v4
        with:
          name: backend-app
          path: final_app/backend/

      - name: ðŸ“¥ Download frontend
        uses: actions/download-artifact@v4
        with:
          name: frontend-app
          path: final_app/

      - name: ðŸ“ Create launcher script (.command)
        run: |
          echo '#!/bin/bash' > final_app/start_app.command
          echo 'echo "Starting backend..."' >> final_app/start_app.command
          echo './backend/main &' >> final_app/start_app.command
          echo 'sleep 2' >> final_app/start_app.command
          echo 'echo "Starting frontend..."' >> final_app/start_app.command
          echo 'open app.app' >> final_app/start_app.command
          chmod +x final_app/start_app.command

      - name: ðŸ“¤ Upload full macOS app
        uses: actions/upload-artifact@v4
        with:
          name: Full-macOS-App
          path: final_app/
